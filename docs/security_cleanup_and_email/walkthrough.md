# 修正内容の確認 (Walkthrough)

セキュリティ修正、コードのクリーンアップ、およびメール通知機能の実装が完了しました。
以下の手順に従って、**Google Apps Script (GAS) の更新と環境設定**を行ってください。

## 実施した変更

### 1. セキュリティ & クリーンアップ
- **GAS**: APIキーとフォルダIDをハードコードから `ScriptProperties` へ移行しました。
- **Next.js**: PDFアップロード/参照API、サイドバー、求人一覧ページから、セキュリティ的に好ましくないログや不要なデバッグログを削除しました。

### 2. メール通知機能
- 以下のタイミングで関係者へメールが自動送信されるようになりました。
    - **学生が応募した時**: 学生へ「応募完了メール」
    - **管理者が応募を承認した時**: 企業へ「新規応募通知メール」
    - **企業がオファーを出した時**: 学生へ「オファー受信メール」
    - **企業が不採用とした時**: 学生へ「選考結果メール」
    - **学生がオファーを承諾した時**: 企業へ「マッチング成立メール」

## 【重要】必要な手動作業（GASの更新）

この機能を利用するには、以下の手順でGASを更新する必要があります。

### 手順 1: GASコードの更新
1. [Google Apps Script エディタ](https://script.google.com/)を開きます。
2. `Code.gs` の内容を、今回更新された [gas/Code.gs](file:///Users/kazuma/Documents/dev/intern/internship-matching/gas/Code.gs) の内容ですべて上書きします。

### 手順 2: スクリプトプロパティの設定
1. GASエディタの左サイドバーから「プロジェクトの設定」（歯車アイコン）を開きます。
2. 最下部の「スクリプト プロパティ」セクションまでスクロールし、「スクリプト プロパティを追加」をクリックします。
3. 以下の2つのプロパティを追加・保存します。
    - `PDF_FOLDER_ID`: PDFを保存するGoogle DriveフォルダのID（既存のものを使用）
    - `API_KEY`: 任意の推測されにくい文字列（例: ランダムな英数字32文字など）

### 手順 3: デプロイの更新
1. 画面右上の「デプロイ」ボタン > 「新しいデプロイ」を選択します。
2. 以下の設定になっているか確認します。
    - **種類**: ウェブアプリ
    - **説明**: (任意。例: "Security fix and email feature")
    - **次のユーザーとして実行**: 自分
    - **アクセスできるユーザー**: **全員**
3. 「デプロイ」をクリックし、**新しいウェブアプリURL** をコピーします。

### 手順 4: Next.js 環境変数の更新
プロジェクトルートの `.env.local` ファイルを開き、以下の環境変数を設定（または更新）します。

```bash
# GASのウェブアプリURL（手順3で取得したもの）
GAS_API_URL=https://script.google.com/macros/s/xxxxxxxxxxxxxxxxx/exec

# 手順2で設定したAPIキーと同じもの
GAS_API_KEY=your_secret_api_key_here
```

## 動作確認方法

1. Next.jsサーバーを再起動します。
2. **学生ユーザー**としてログインし、求人に応募します。
    - Firestoreのユーザーデータに登録されているメールアドレスに「応募完了のお知らせ」が届けば成功です。
3. **管理者ユーザー**でログインし（またはFirestoreを直接操作し）、応募ステータスを `pending_company` に変更します。
    - 企業のメールアドレスに通知が届くか確認します。
